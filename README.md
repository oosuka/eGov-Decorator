# e-Gov Decorator

e-Gov 法令ページ内の全角括弧 `（...）` をハイライト表示する Chromium 系ブラウザ拡張です。  
対応ブラウザは Chrome / Microsoft Edge です。

- 対象URL:
  - `https://laws.e-gov.go.jp/*`
  - `https://elaws.e-gov.go.jp/*`

## 主な機能

1. 対象ページ内の全角括弧 `（...）` をハイライト表示
2. ショートカットでハイライトレベル切り替え（既定: Windows `Ctrl+Shift+X` / macOS `Command+Shift+X`）
3. 拡張アイコンのバッジで状態表示
4. 対象ページで拡張アイコンクリック時に色設定ポップアップを表示

## バッジ表示仕様

- 対象ページかつハイライト有効（`H1`〜`H4`）: `H1` / `H2` / `H3` / `H4`（赤背景）
- 対象ページかつハイライト無効: `OFF`（緑背景）
- 対象外ページ: 表示なし

バッジが見えない場合は、ツールバーで拡張をピン留めしてください。

## 使い方

### 1. インストール（Chrome）

1. `chrome://extensions` を開く
2. 右上の「デベロッパーモード」を ON
3. 「パッケージ化されていない拡張機能を読み込む」をクリック
4. このリポジトリのフォルダを選択

### 2. インストール（Edge）

1. `edge://extensions` を開く
2. 左メニューの「開発者モード」を ON
3. 「展開して読み込み」をクリック
4. このリポジトリのフォルダを選択

更新時は拡張機能一覧で「更新」または対象拡張の再読み込みを実行してください。

### 3. 色設定（ポップアップ）

1. ツールバーの `e-Gov Decorator` アイコンをクリック
2. 背景色・文字色を選択して「保存」
3. 「デフォルトに戻す」で既定値に戻す

右クリックメニューの「オプション」は使用しない構成です。
対象外ページでは「対象外のページです。」と表示されます。

### 4. ハイライトレベル切り替え

- 既定ショートカット:
  - Windows / Linux: `Ctrl+Shift+X`
  - macOS: `Command+Shift+X`
- 切り替え順:
  - `H1`（1階層目からハイライト）
  - `H2`（2階層目からハイライト）
  - `H3`（3階層目からハイライト）
  - `H4`（4階層目からハイライト）
  - `OFF`（ハイライトなし）
- 表記の意味:
  - `Hn` は「n階層目からハイライト」を表します。
  - `H1` は 1階層目からなので、結果として括弧内全体がハイライトされます。
- キー変更:
  - Chrome: `chrome://extensions/shortcuts`
  - Edge: `edge://extensions/shortcuts`
- 既存インストール環境では、ショートカット割り当てが自動で切り替わらない場合があります。その場合はショートカット設定画面で一度手動設定してください。

ショートカットが効かない場合:

1. `chrome://extensions/shortcuts` または `edge://extensions/shortcuts` で割り当てを確認
2. 既定値に戻らない場合は拡張を一度削除して再インストール

## 設定の保存と反映

- 保存先は `chrome.storage.local`
- 保存項目:
  - `highlightLevel`（内部値 `0..4`。表示上は `H1`〜`H4` / `OFF`）
  - `decoratorEnabled`（後方互換のため同期）
  - `highlightBgColor`
  - `highlightTextColor`
- `storage` の変更検知で全タブへ状態を反映
- タブ切り替え・URL変更・起動時にバッジ状態を再評価

## 既定値

- 背景色: `#e6e6e6`
- 文字色: `#ffffff`
- 初回インストール時: `H1`（1階層目からハイライト）

## 確認チェック（Chrome / Edge）

1. ツールバーで `e-Gov Decorator` をピン留め
2. `https://laws.e-gov.go.jp/` または `https://elaws.e-gov.go.jp/` を開く
3. 全角括弧 `（...）` がハイライトされることを確認
4. バッジが `H1`（赤）で表示されることを確認
5. Windowsは `Ctrl+Shift+X`、macOSは `Command+Shift+X` で `H2` / `H3` / `H4` / `OFF` / `H1` の順に循環することを確認
6. 対象外ページでバッジが消えることを確認
7. ポップアップで色変更し、即時反映されることを確認
8. 再読み込み後もハイライトレベルと色設定が維持されることを確認

## ファイル構成

- `src/background.js`: ショートカット処理、バッジ更新、タブ/ウィンドウイベント監視
- `src/content.js`: ハイライト適用、DOM 変化追従（`MutationObserver`）
- `src/popup.html` + `src/options.js` + `src/options.css`: 色設定 UI
- `assets/icons/`: 拡張アイコン
- `tests/`: `node:test` ベースの単体テスト

## ハイライト仕様（補足）

- 対象括弧は全角括弧 `（` `）` のみです。
- 基本はテキストノード単位で処理します。
- ただし、同一の安全コンテナ内ではノードをまたぐ括弧（例: リンクをまたぐ括弧）も処理します。
- ノードまたぎ処理を含め、ハイライト対象は対応する `（...）` ペアのみです（未閉じ `（` はハイライトしません）。
- `table` / `tr` / `td` / `th` などの表系要素配下では、安全のためノードまたぎ処理を行わず、従来のノード単位処理へフォールバックします。
- レベル切替時は、既存ハイライト解除後に `normalize()` を実行して隣接テキストノードを再結合し、再適用時の取りこぼしを抑制します。

## テスト実行

```bash
npm run test
```

## Lint / Format

```bash
npm run lint
npm run lint:fix
npm run format:check
npm run format
```

## セキュリティ

- 本拡張は外部サーバーへの送信機能（API連携、アップロード、Webhook等）を実装していません。
- 保存データは `chrome.storage.local` 内の設定値（ハイライトレベル、色設定）のみです。
- 権限は `storage` と `tabs` のみを使用し、対象外のサイトには動作しません。
- 処理内容は対象URL上の表示装飾（ハイライト）に限定され、業務データの収集や外部転送は行いません。
